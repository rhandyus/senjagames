# WinPay Signature Generation - Implementation Guide

## Overview

This guide explains how to implement WinPay signature generation according to their SNAP API specification using RSA-SHA256 signatures.

## Signature Generation Rules

According to WinPay documentation:

```
stringToSign = HTTPMethod + ":" + EndpointUrl + ":" + Lowercase(HexEncode(SHA-256(minify(RequestBody)))) + ":" + TimeStamp
signature = base64_encode(SHA256withRSA(private_key, stringToSign))
```

## Implementation

### 1. Client-Side (Browser) Implementation

**File**: `src/utils/winpaySignature.js`

Uses `node-rsa` library for RSA operations in the browser.

**Key Functions**:

- `generateWinPaySignature()` - Generate signature for API requests
- `verifyWinPaySignature()` - Verify signatures (for testing)
- `generateTestKeyPair()` - Generate RSA keys for development

### 2. Server-Side (Node.js) Implementation

**File**: `src/utils/winpaySignatureServer.js`

Uses Node.js built-in `crypto` module for better performance and security.

**Key Functions**:

- `generateWinPaySignatureServer()` - Generate signature for server API requests
- `verifyWinPaySignatureServer()` - Verify callback signatures
- `extractPublicKeyServer()` - Extract public key from private key

## Setup Instructions

### Step 1: Install Dependencies

```powershell
npm install node-rsa
```

### Step 2: Generate RSA Key Pair

Run the key generation script:

```powershell
node generate-winpay-keys.js
```

This will output:

- **Private Key**: Add to your `.env` file as `VITE_WINPAY_PRIVATE_KEY`
- **Public Key**: Send to WinPay for configuration in their dashboard

### Step 3: Configure Environment Variables

Add to your `.env` file:

```env
VITE_WINPAY_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----"
VITE_WINPAY_PARTNER_ID=fe515458-df5e-4ab6-9136-84b18e79f1e8
VITE_WINPAY_CHANNEL_ID=SenjaGames
VITE_WINPAY_BASE_URL=https://api.winpay.id
```

### Step 4: Update WinPayAPI Service

The `WinPayAPI` class in `src/services/winpayAPI.js` has been updated to use the new signature generation:

```javascript
import { generateWinPaySignature } from '../utils/winpaySignature.js'

class WinPayAPI {
  generateSignature(httpMethod, endpointUrl, requestBody, timestamp) {
    return generateWinPaySignature(httpMethod, endpointUrl, requestBody, timestamp, this.privateKey)
  }
}
```

## Testing

### Test Signature Generation

Run the test script to verify signature generation:

```powershell
node test-winpay-signature.js
```

Expected output:

```
Testing WinPay Signature Generation...
======================================

--- Signature Generation ---
WinPay Signature Generation:
- HTTP Method: POST
- Endpoint URL: /v1.0/transfer-va/create-va
- Body Hash: ccd2099f26be6196c29deb878406f282b4f9eddcaf746d4d8ded79d8d42751e0
- String to Sign: POST:/v1.0/transfer-va/create-va:ccd2099f26be6196c29deb878406f282b4f9eddcaf746d4d8ded79d8d42751e0:2023-09-19T12:11:14+07:00
- Generated Signature: EdmgJ330Vp+PJoiCilP1Q9Q7FSujA9eA+oeWlaqay+QO...

--- Signature Verification ---
Signature Verification: VALID âœ…
```

## API Usage Examples

### Creating Virtual Account with Signature

```javascript
const winpay = new WinPayAPI()

const paymentData = {
  amount: 150000,
  items: [{ name: 'Steam Account', price: 150000 }],
  channel: 'BCA',
  customerName: 'John Doe'
}

try {
  const response = await winpay.createVirtualAccount(paymentData)
  console.log('Virtual Account Created:', response)
} catch (error) {
  console.error('Payment Error:', error)
}
```

### Verifying Callback Signatures

For callback endpoints (server-side):

```javascript
import { verifyWinPaySignatureServer } from '../utils/winpaySignatureServer.js'

export default async function handler(req, res) {
  const timestamp = req.headers['x-timestamp']
  const signature = req.headers['x-signature']
  const publicKey = process.env.WINPAY_PUBLIC_KEY

  const isValid = verifyWinPaySignatureServer(req.body, timestamp, signature, publicKey)

  if (!isValid) {
    return res.status(401).json({
      responseCode: '4010000',
      responseMessage: 'Invalid signature'
    })
  }

  // Process callback...
}
```

## WinPay Dashboard Configuration

### 1. Add Public Key

1. Login to WinPay Dashboard
2. Go to API Configuration
3. Add your **Public Key** (generated by the script)
4. Save configuration

### 2. Configure Callback URL

Set your callback URL in WinPay dashboard:

- **Development**: `https://your-ngrok-url.ngrok.io/api/winpay/v1.0/transfer-va/payment`
- **Production**: `https://yourdomain.com/api/winpay/v1.0/transfer-va/payment`

## Security Notes

### Production Security

1. **Private Key Protection**: Store private keys securely, never commit to git
2. **Environment Variables**: Use proper environment variable management
3. **Key Rotation**: Regularly rotate RSA keys (recommended: every 6 months)
4. **Signature Verification**: Always verify callback signatures in production

### Development vs Production

- **Development**: Mock signatures are used when no private key is provided
- **Production**: Real RSA signatures are required for API authentication

## Troubleshooting

### Common Issues

1. **"Invalid signature" errors**:
   - Check private key format (must include `\n` characters)
   - Verify endpoint URL matches exactly
   - Ensure timestamp format is correct (ISO8601 with +07:00 timezone)

2. **"No private key provided" warnings**:
   - Check `.env` file has correct `VITE_WINPAY_PRIVATE_KEY`
   - Verify key format (should be PEM format with newlines escaped)

3. **Callback verification fails**:
   - Ensure public key is correctly configured in WinPay dashboard
   - Check callback URL configuration
   - Verify request body is not modified before verification

### Debug Logs

Enable debug logging by checking console output during signature generation:

```
WinPay Signature Generation:
- HTTP Method: POST
- Endpoint URL: /v1.0/transfer-va/create-va
- Request Body: {"customerNo":"..."}
- Body Hash: ccd2099f26be6196c29deb878406f282b4f9eddcaf746d4d8ded79d8d42751e0
- Timestamp: 2023-09-19T12:11:14+07:00
- String to Sign: POST:/v1.0/transfer-va/create-va:ccd2099f26be6196c29deb878406f282b4f9eddcaf746d4d8ded79d8d42751e0:2023-09-19T12:11:14+07:00
- Generated Signature: EdmgJ330Vp+PJoiCilP1Q9Q7FSujA9eA+oeWlaqay+QO...
```

## Files Created/Modified

### New Files:

- `src/utils/winpaySignature.js` - Client-side signature utilities
- `src/utils/winpaySignatureServer.js` - Server-side signature utilities
- `generate-winpay-keys.js` - RSA key pair generator
- `test-winpay-signature.js` - Signature testing script
- `WINPAY_SIGNATURE_GUIDE.md` - This documentation

### Modified Files:

- `src/services/winpayAPI.js` - Updated to use new signature generation
- `.env` - Added private key configuration

## Next Steps

1. **Test Integration**: Test payment flow end-to-end with WinPay sandbox
2. **Callback Implementation**: Update callback handlers to use RSA verification
3. **Error Handling**: Implement proper error handling for signature failures
4. **Monitoring**: Add logging and monitoring for signature-related issues

---

**Note**: This implementation follows WinPay's SNAP API specification for "Asymmetric Without Get Token" signature generation using RSA-SHA256.
